
<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<title>reveal.js - Markdown Example</title>
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/white.css" id="theme">
        <link rel="stylesheet" href="plugin/highlight/monokai.css">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

		<style type="text/css">
			#overlay {
				position: fixed; /* Sit on top of the page content */
				display: show;
				width: 300px; /* Full width (cover the whole page) */
				height: 157px; /* Full height (cover the whole page) */
				top: 74%;
				left: 79%;
				right: 0;
				bottom: 0;
				background-color: rgba(2, 253, 199, 0.89); /* Black background with opacity */
				z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
				cursor: pointer; /* Add a pointer on hover */
			  }
		</style>
	</head>

	<body>
		<div id="overlay">
			<div id="overlayheader">MOVER</div>
				<form>
					<div class="form-group">
						<div class="form-check form-check-inline">
							<input class="form-check-input" type="checkbox" id="check" onclick="check2();" value="option1">
							<label class="form-check-label" for="check" id="labelcheck">Ocultar</label>
						</div>	
					  
					  
					</div>
					<div class="form-group" id="contain" >
					   <button type="button" class="btn btn-outline-secondary" id="btn_savenote" onclick="saveNote();">Guardar</button>
					  
					  <textarea class="form-control" id="textnote" name="textnote" rows="5" cols="39">
					</textarea>
					</div>
				  </form>				
			
		</div> 
		<div class="reveal">
            <span style="color:black; font-size: x-large; margin-left: 5%;" id="titleSpan" ></span>
			<div class="slides">
				<section data-markdown="https://johnwry.github.io/dm2/markdown/1-Timoteo/1timoteo_pres.md"
				data-separator="^\n"
								  data-separator-vertical="^___"
						   data-separator-notes="^Note:">
			  </section>
			</div>
		</div>


		<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>

		<script src="dist/reveal.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script src="plugin/notes/notes.js"></script>
		<script src="plugin/menu/menu.js"></script>
		

		<script>

		
		check2();	
		function check2(){

			if(document.getElementById('check').checked) {
				on();
			} else {
				off();
			}
			//alert("asd");	
		}

		function on() {
		  //document.getElementById("overlay").style.display = "block";
		  //document.getElementById("btn_hide").style.display = "block";
		  document.getElementById("labelcheck").textContent="Ocultar"
		  document.getElementById("contain").style.display = "block"; 
		  document.getElementById("overlay").style.width= "300px";
		  document.getElementById("overlay").style.height= "157px";
		}

		function off() {
		  //document.getElementById("overlay").style.display = "none";
		  //document.getElementById("btn_hide").style.display = "none";
		  document.getElementById("labelcheck").textContent="Mostrar"
		  document.getElementById("contain").style.display = "none";
		  document.getElementById("overlay").style.width= "80px";
		  document.getElementById("overlay").style.height= "30px";
		}
		dragElement(document.getElementById("overlay"));

		function dragElement(elmnt) {
		  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
		  if (document.getElementById(elmnt.id + "header")) {
		    // if present, the header is where you move the DIV from:
		    document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
		  } else {
		    // otherwise, move the DIV from anywhere inside the DIV:
		    elmnt.onmousedown = dragMouseDown;
		  }

		  function dragMouseDown(e) {
		    e = e || window.event;
		    e.preventDefault();
		    // get the mouse cursor position at startup:
		    pos3 = e.clientX;
		    pos4 = e.clientY;
		    document.onmouseup = closeDragElement;
		    // call a function whenever the cursor moves:
		    document.onmousemove = elementDrag;
		  }

		  function elementDrag(e) {
		    e = e || window.event;
		    e.preventDefault();
		    // calculate the new cursor position:
		    pos1 = pos3 - e.clientX;
		    pos2 = pos4 - e.clientY;
		    pos3 = e.clientX;
		    pos4 = e.clientY;
		    // set the element's new position:
		    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
		    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
		  }

		  function closeDragElement() {
		    // stop moving when mouse button is released:
		    document.onmouseup = null;
		    document.onmousemove = null;
		  }
		}

		
			const url_token ="https://www.redbiblica.org/wp-json/jwt-auth/v1/token";
			//const url_serverRed = 'http://www.redbiblica.org:3000/api/v1/';
			const url_server = 'https://redbiblica.duckdns.org:3000/api/v1/';
			var idtopic = 1;
			var currentNoteId=-1;
			var listNotes = Array();
			var auxh = 0;
			var auxv = 0;
			var token = "";
			document.getElementById("textnote").value = "";
			//document.getElementById("btn_savenote").disabled = true;
			function saveNote(){
				document.getElementById("btn_savenote").disabled = true;
				//document.getElementById("btn_savenote").setAttribute("class", "notes")
				if(currentNoteId==-1){
					const text = document.getElementById("textnote").value;
					fetch(url_server + 'notes',
					{
						method: "POST",
						body: JSON.stringify({
							text: text,
							topic: idtopic,
							version: 1,
							h: auxh,
							v: auxv
						}),
						headers: {
							'Content-Type': 'application/json',
							'Authorization': "Bearer "+token
						}
					})
					.then((response) => {
						console.log("response.data");
						console.log(response);
						return response.json()
					})
					.then((res) => {
						console.log("res");
						console.log(res);
						currentNoteId = res.note.id;//set
						
						res.note.isSet = false;
						listNotes.push(
							res.note
						);

						localStorage.removeItem('Notes');
						localStorage.setItem('Notes', JSON.stringify(listNotes));
						console.log("save------");
						console.log(listNotes);
						document.getElementById("btn_savenote").textContent="Actualizar";
						document.getElementById("btn_savenote").disabled = false;
					})
					.catch(function(error) {
						console.log('Hubo un error:' + error.message);
					});
				}else{
					console.log("currentNoteId")
					console.log(currentNoteId)
					updateNote(currentNoteId);
				}
			}

			function updateNote(idNote){
				const text = document.getElementById("textnote").value;
				fetch(url_server + 'notes/id/'+idNote,
				{
					method: "PATCH",
					body: JSON.stringify({
						text: text,
						topic: idtopic,
						version: 1,
						h: auxh,
						v: auxv
					}),
					headers: {
						'Content-Type': 'application/json',
						'Authorization': "Bearer "+token
					}
				})
				.then((response) => {
					console.log(response);
					return response.json()
				})
				.then((res) => {
					console.log("res");
					console.log(res);
					const result = listNotes.find( ele => ele.h === auxh && ele.v === auxv );
					console.log(result);
					result.isSet = false;
					result.text = text;
					console.log("listNotes");
					console.log(listNotes);

					localStorage.removeItem('Notes');
					localStorage.setItem('Notes', JSON.stringify(listNotes));
					document.getElementById("btn_savenote").disabled = false;		
				})
				.catch(function(error) {
					console.log('Hubo un error:' + error.message);
				});

				//alert("asd");
			}

			
			

			
			var list = JSON.parse(localStorage.getItem('Notes'));
			login();
			function login() {
				//console.log(user)
				if(list){
					listNotes=list;
				}
				console.log(url_token);
				fetch(url_token ,
				{
					method: "POST",
					body: JSON.stringify({
						username: "pruebaprueba",
						password: "12345"
					}),
					headers: {
						'Content-Type': 'application/json'
					}
				})
				.then((response) => {
					return response.json()
				})
				.then((res) => {
					console.log("login");   
					console.log(res);
					token = res.token;    
					getNotes();     
				})
				.catch(function(error) {
					setArray();
					starReveal();         
					console.log('Hubo un error:' + error.message);
				});
			}

			function getNotes() {				
				
				//console.log(user)
				fetch(url_server + 'notes/topic/1',
				{
					method: "GET",
					headers: {
						'Content-Type': 'application/json',
						'Authorization': "Bearer "+token
					}
				})
				.then((response) => {
					return response.json()
				})
				.then((res) => {
					console.log("asdasd");
					console.log(res);
					if(res.status){
						listNotes = new Array();
						localStorage.removeItem('Notes');
					}else{
						for(var i=0;i < res.length;i++){
							res[i].isSet = false;
						}					
						listNotes = res;
						console.log(listNotes);
						localStorage.removeItem('Notes');
						localStorage.setItem('Notes', JSON.stringify(res));
						console.log("listNotes");
					}
					starReveal();
					
				})
				.catch(function(error) {  
					starReveal();       
					console.log('Hubo un error:' + error.message);
				});
			}

			function starReveal(){
				Reveal.initialize({
					controls: true,
					progress: true,
					history: true,
					center: true,
					plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
				});
				
				
				Reveal.on('slidechanged', event => {
					// event.previousSlide, event.currentSlide, event.indexh, event.indexv
					console.log("----------------");
					auxh = event.indexh;
					auxv = event.indexv;
					
					
					const result = listNotes.find( ele => ele.h === event.indexh && ele.v === event.indexv );
					console.log(result);
					if(result){
						document.getElementById("btn_savenote").textContent="Actualizar";
						currentNoteId = result.id;//set 
						document.getElementById("textnote").value = result.text;
						if(!result.isSet){
							result.isSet = true;
							const currentNote = event.currentSlide.childNodes[event.currentSlide.childNodes.length-1];
							if(currentNote.className=="notes"){
								console.log("actualizar")
								currentNote.innerText=result.text;
							}
							else{
								console.log("agregar")
								var aside = document.createElement("aside");
								aside.setAttribute("class", "notes");
								aside.textContent = result.text;
								event.currentSlide.appendChild(aside);
							}
							
						}
					}else{
						document.getElementById("btn_savenote").textContent="Guardar"; 
						currentNoteId = -1;
						document.getElementById("textnote").value = "";
					}
					
					for(var i=0; i<event.currentSlide.childNodes.length; i++){
						if(event.currentSlide.childNodes[0].localName){
							if(event.currentSlide.childNodes[i].localName == "h2"){					
								console.log("si es h2")
								var h = event.currentSlide.childNodes[i].localName;
								document.getElementById("titleSpan").innerText = event.currentSlide.childNodes[i].textContent;
								i = event.currentSlide.childNodes.length;
							}
							else{
								//document.getElementById("titleSpan").innerText="NO h2";
								//console.log("NO h2")
							}
						}else{
							console.log("sale")
							document.getElementById("titleSpan").innerText = "";
							i = event.currentSlide.childNodes.length;
						}
					}
					console.log(event.indexh+","+ event.indexv);
				});

			}

			function setArray(){
				for(var i=0;i < listNotes.length;i++){
					listNotes[i].isSet = false;
				}

			}
		</script>

	</body>
</html>
